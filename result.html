<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•ç¥¨çµæœ ğŸ†</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 40px auto; padding: 20px; line-height: 1.6; background: #f0f2f5; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        h2 { color: #333; margin-bottom: 20px; border-bottom: 2px solid #ff6b6b; display: inline-block; padding-bottom: 5px; }
        .ranking-container { margin-top: 20px; }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: #fff; border: 1px solid #eee; border-radius: 10px; transition: 0.3s; }
        /* 1ä½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .ranking-item:nth-child(1) { background: #fff9db; border-color: #fcc419; transform: scale(1.05); font-weight: bold; box-shadow: 0 4px 10px rgba(252, 196, 25, 0.2); }
        .rank-badge { background: #ff6b6b; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .vote-count { color: #4dabf7; font-weight: bold; font-size: 1.2em; }
        .back-btn { margin-top: 20px; display: inline-block; text-decoration: none; color: #888; font-size: 14px; }
        .loading { color: #888; font-style: italic; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="pageTitle">æŠ•ç¥¨çµæœ ğŸ†</h2>
    <div id="rankingList" class="ranking-container">
        <p class="loading">æœ€æ–°ã®çµæœã‚’å–å¾—ä¸­...</p>
    </div>
    <a href="index.html" id="backToVote" class="back-btn">â† æŠ•ç¥¨ä½œæˆç”»é¢ã¸</a>
</div>

<script>
    // æä¾›ã„ãŸã ã„ãŸGASã®URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz4USTEMcdvUl0j1EIuL6sbPftjJikcoECPSLqwjjawZ2tbXqgZSQmbRsVDSd8eLdBu/exec";

    async function loadRanking() {
        const hash = window.location.hash.substring(1);
        if (!hash.startsWith("items=")) {
            document.getElementById('rankingList').innerHTML = "<p>æŠ•ç¥¨ãƒšãƒ¼ã‚¸ãŒç‰¹å®šã§ãã¾ã›ã‚“ã€‚<br>æ­£ã—ã„URLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>";
            return;
        }
        
        const encodedData = hash.replace("items=", "");
        const pageId = encodedData.substring(0, 10); // è­˜åˆ¥ã®ãŸã‚ã®å…ˆé ­10æ–‡å­—

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ãƒªãƒ³ã‚¯ã‚‚ç¶­æŒ
        document.getElementById('backToVote').href = "index.html#items=" + encodedData;

        try {
            // GASã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            const response = await fetch(GAS_URL);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const rows = await response.json(); // GASã‹ã‚‰å±Šã„ãŸå…¨å›ç­”ãƒ‡ãƒ¼ã‚¿
            
            const counts = {};
            // GASã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ : [ [ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—, list_id, item_name], ... ]
            rows.forEach(row => {
                const listId = String(row[1]).trim();
                const itemName = String(row[2]).trim();
                
                // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸IDã«ä¸€è‡´ã™ã‚‹å›ç­”ã ã‘ã‚’é›†è¨ˆ
                if (listId === pageId) {
                    counts[itemName] = (counts[itemName] || 0) + 1;
                }
            });

            // é›†è¨ˆçµæœã‚’é…åˆ—ã«ã—ã¦é™é †ã‚½ãƒ¼ãƒˆ
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            const container = document.getElementById('rankingList');
            
            if (sorted.length === 0) {
                container.innerHTML = "<p>ã¾ã æŠ•ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã‚ãªãŸãŒæœ€åˆã®1ç¥¨ã‚’æŠ•ã˜ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</p>";
                return;
            }

            // HTMLç”Ÿæˆ
            container.innerHTML = sorted.map(([name, count], index) => `
                <div class="ranking-item">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="rank-badge">${index + 1}</span>
                        <span>${name}</span>
                    </div>
                    <span class="vote-count">${count} ç¥¨</span>
                </div>
            `).join('');

        } catch (e) {
            console.error("Error:", e);
            document.getElementById('rankingList').innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br><small>GASã®è¨­å®šï¼ˆå…¨å“¡ã«å…¬é–‹ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small></p>";
        }
    }

    // åˆå›èª­ã¿è¾¼ã¿
    loadRanking();
    
    // 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°ï¼ˆå¿…è¦ãªã‘ã‚Œã°æ¶ˆã—ã¦ã‚‚OKï¼‰
    setInterval(loadRanking, 30000);
</script>
</body>
</html>

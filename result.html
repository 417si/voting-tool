<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•ç¥¨çµæœ ğŸ†</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 40px auto; padding: 20px; line-height: 1.6; background: #f0f2f5; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        h2 { color: #333; margin-bottom: 5px; border-bottom: 2px solid #ff6b6b; display: inline-block; padding-bottom: 5px; }
        
        /* æŠ•ç¥¨è€…æ•°ã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .vote-stats { margin: 20px 0; background: #f8f9fa; padding: 10px; border-radius: 12px; border: 1px solid #e9ecef; }
        .vote-total { font-size: 24px; font-weight: bold; color: #ff6b6b; }
        .vote-label { font-size: 14px; color: #868e96; }

        .ranking-container { margin-top: 10px; }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: #fff; border: 1px solid #eee; border-radius: 10px; transition: 0.3s; }
        .ranking-item:nth-child(1) { background: #fff9db; border-color: #fcc419; transform: scale(1.05); font-weight: bold; box-shadow: 0 4px 10px rgba(252, 196, 25, 0.2); }
        .rank-badge { background: #ff6b6b; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .vote-count { color: #4dabf7; font-weight: bold; font-size: 1.2em; }
        
        .refresh-btn { 
            margin-top: 25px; 
            display: inline-block; 
            padding: 10px 20px;
            background-color: #f1f3f5;
            color: #495057;
            text-decoration: none; 
            border-radius: 8px;
            border: 1px solid #dee2e6;
            font-size: 14px; 
            cursor: pointer;
            transition: 0.2s;
        }
        .refresh-btn:hover { background-color: #e9ecef; }
        .auto-msg { font-size: 11px; color: #adb5bd; margin-top: 8px; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="pageTitle">æŠ•ç¥¨çµæœ ğŸ†</h2>
    
    <div class="vote-stats">
        <span class="vote-label">ç¾åœ¨ã®å‚åŠ äººæ•°</span><br>
        <span id="totalVoters" class="vote-total">0</span> <span class="vote-label">äºº</span>
    </div>

    <div id="rankingList" class="ranking-container">
        <p>æœ€æ–°ã®çµæœã‚’å–å¾—ä¸­...</p>
    </div>
    
    <button onclick="location.reload()" id="refreshBtn" class="refresh-btn">ğŸ”„ æœ€æ–°ã®çµæœã«æ›´æ–°ã™ã‚‹</button>
    <p class="auto-msg" id="timerMsg">â€»10ç§’ã”ã¨ã«è‡ªå‹•ã§æ›´æ–°ã•ã‚Œã¾ã™</p>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz4USTEMcdvUl0j1EIuL6sbPftjJikcoECPSLqwjjawZ2tbXqgZSQmbRsVDSd8eLdBu/exec";

    async function generateHash(text) {
        const msgUint8 = new TextEncoder().encode(text);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
    }

    async function loadRanking() {
        const timerMsg = document.getElementById('timerMsg');
        timerMsg.innerText = "åŒæœŸä¸­...";

        const hash = window.location.hash.substring(1);
        if (!hash.startsWith("items=")) return;
        
        const encodedData = hash.replace("items=", "");
        const targetHash = await generateHash(encodedData);

        try {
            const response = await fetch(GAS_URL);
            const rows = await response.json();
            
            const counts = {};
            let totalVoters = 0; // â˜… åˆè¨ˆäººæ•°ç”¨ã®å¤‰æ•°

            rows.forEach(row => {
                if (String(row[1]).trim() === targetHash) {
                    const itemName = String(row[2]).trim();
                    counts[itemName] = (counts[itemName] || 0) + 1;
                    totalVoters++; // â˜… ä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ãŸã³ã«ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
                }
            });

            // â˜… äººæ•°ã‚’ç”»é¢ã«åæ˜ 
            document.getElementById('totalVoters').innerText = totalVoters;

            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            const container = document.getElementById('rankingList');
            
            if (sorted.length === 0) {
                container.innerHTML = "<p>ã¾ã æŠ•ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
            } else {
                container.innerHTML = sorted.map(([name, count], index) => `
                    <div class="ranking-item">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span class="rank-badge">${index + 1}</span>
                            <span>${name}</span>
                        </div>
                        <span class="vote-count">${count} ç¥¨</span>
                    </div>
                `).join('');
            }
            timerMsg.innerText = "â€»10ç§’ã”ã¨ã«è‡ªå‹•ã§æ›´æ–°ã•ã‚Œã¾ã™";

        } catch (e) {
            timerMsg.innerText = "æ¥ç¶šã‚¨ãƒ©ãƒ¼ã€‚å†è©¦è¡Œä¸­...";
        }
    }

    loadRanking();
    setInterval(loadRanking, 10000);
</script>
</body>
</html>

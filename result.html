<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•ç¥¨çµæœ ğŸ†</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 40px auto; padding: 20px; line-height: 1.6; background: #f0f2f5; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        h2 { color: #333; margin-bottom: 5px; border-bottom: 2px solid #ff6b6b; display: inline-block; padding-bottom: 5px; }
        
        /* å‚åŠ äººæ•°ã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .voter-stats { margin-bottom: 20px; font-size: 14px; color: #666; font-weight: bold; padding: 10px; background: #f8f9fa; border-radius: 8px; display: inline-block; }
        .voter-count { color: #ff6b6b; font-size: 18px; margin: 0 4px; }

        .ranking-container { margin-top: 20px; text-align: left; }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: #fff; border: 1px solid #eee; border-radius: 10px; transition: 0.3s; }
        
        /* 1ä½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .ranking-item:nth-child(1) { background: #fff9db; border-color: #fcc419; transform: scale(1.02); font-weight: bold; }
        
        .rank-badge { background: #ff6b6b; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .ranking-item:nth-child(1) .rank-badge { background: #fcc419; }
        
        .vote-count { font-weight: bold; color: #4dabf7; }
        .btn-back { display: inline-block; margin-top: 30px; color: #4dabf7; text-decoration: none; font-size: 14px; font-weight: bold; }
        .btn-back:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="pageTitle">æŠ•ç¥¨çµæœ ğŸ†</h2>
    
    <div id="statsArea" style="display:none; margin-top: 15px;">
        <div class="voter-stats">
            å‚åŠ äººæ•°:<span id="voterCount" class="voter-count">0</span>äºº
        </div>
    </div>

    <div id="rankingList" class="ranking-container">
        <p style="text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <a href="javascript:history.back()" class="btn-back">â¬… æŠ•ç¥¨ç”»é¢ã«æˆ»ã‚‹</a>
</div>

<script>
    // æ›´æ–°ã•ã‚ŒãŸGASã®URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxifxEaMAq931nBtTeeGmL5vvCLFEBFcNyk0EknOgp8BLnsa5UHZGKzGepanx1kpS1N/exec"; 

    async function generateHash(text) {
        const msgUint8 = new TextEncoder().encode(text);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
    }

    async function loadRanking() {
        const params = new URLSearchParams(window.location.hash.substring(1));
        const pageRawData = params.get('items');
        if (!pageRawData) return;

        const pageId = await generateHash(pageRawData);

        try {
            const response = await fetch(GAS_URL);
            const data = await response.json();
            
            // GASãŒ {rows: [...]} ã‚’è¿”ã™ã‹ [...] ã‚’è¿”ã™ã‹ã«ã‹ã‹ã‚ã‚‰ãšå¯¾å¿œ
            const rows = data.rows || data || [];

            const counts = {};
            const voterIds = new Set(); // é‡è¤‡ã—ãªã„UIDã‚’ä¿å­˜ã™ã‚‹ã‚»ãƒƒãƒˆ

            rows.forEach(row => {
                // rowæ§‹æˆ: [0]ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—, [1]ãƒªã‚¹ãƒˆID, [2]é …ç›®å, [3]UID
                const listId = String(row[1] || "").trim();
                const itemName = String(row[2] || "").trim();
                const uid = row[3] ? String(row[3]).trim() : null;

                if (listId === pageId) {
                    // å„é …ç›®ã®ç´”ç²‹ãªç²å¾—ç¥¨æ•°
                    counts[itemName] = (counts[itemName] || 0) + 1;
                    
                    // åŒä¸€ã‚»ãƒƒã‚·ãƒ§ãƒ³UIDã‚’Setã«è¿½åŠ 
                    if (uid && uid !== "") {
                        voterIds.add(uid);
                    }
                }
            });

            // å‚åŠ äººæ•°ã®è¡¨ç¤ºæ›´æ–°
            const statsArea = document.getElementById('statsArea');
            const voterCountEl = document.getElementById('voterCount');
            if (voterIds.size > 0) {
                voterCountEl.innerText = voterIds.size;
                statsArea.style.display = "block";
            } else {
                statsArea.style.display = "none";
            }

            // é›†è¨ˆçµæœã‚’é…åˆ—ã«ã—ã¦ã‚½ãƒ¼ãƒˆ
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            const container = document.getElementById('rankingList');
            
            if (sorted.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999;'>ã¾ã æŠ•ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
                return;
            }

            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°HTMLã®ç”Ÿæˆ
            container.innerHTML = sorted.map(([name, count], index) => `
                <div class="ranking-item">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="rank-badge">${index + 1}</span>
                        <span>${name}</span>
                    </div>
                    <span class="vote-count">${count} ç¥¨</span>
                </div>
            `).join('');

        } catch (e) {
            console.error("Fetch Error:", e);
            document.getElementById('rankingList').innerHTML = "<p style='text-align:center; color:red;'>ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br><small>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚„GASã®å…¬é–‹è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small></p>";
        }
    }

    // åˆå›å®Ÿè¡Œ
    loadRanking();
    
    // 30ç§’ã”ã¨ã«çµæœã‚’è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    setInterval(loadRanking, 30000);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•ç¥¨ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 40px auto; padding: 20px; line-height: 1.6; background: #f0f2f5; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h2 { text-align: center; color: #333; margin-top: 0; }
        textarea { width: 100%; height: 120px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; padding: 12px; box-sizing: border-box; font-size: 14px; }
        .btn-main { width: 100%; padding: 14px; background: #ff6b6b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; }
        .btn-main:hover { background: #fa5252; }
        .btn-main:disabled { background: #ccc; cursor: not-allowed; }
        .config-group { background: #fff5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; border: 1px solid #ffe3e3; }
        .config-item { display: flex; align-items: center; justify-content: space-between; }
        .item-label { display: block; background: #4dabf7; color: white; padding: 14px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; text-align: center; font-weight: bold; position: relative; overflow: hidden; }
        .item-label:hover { background: #339af0; }
        .my-vote-label { background: #51cf66 !important; color: #fff !important; border: 2px solid #40c057; box-shadow: 0 4px 8px rgba(64, 192, 87, 0.2); }
        input[type="checkbox"] { display: none; }
        input[type="checkbox"]:checked + .item-label { background: #1864ab; box-shadow: inset 0 0 12px rgba(0,0,0,0.2); }
        input[type="checkbox"]:checked + .item-label::after { content: "âœ“"; position: absolute; right: 15px; }
        input[type="checkbox"]:disabled + .item-label { background: #ced4da; cursor: not-allowed; }
        .vote-divider { border: 0; border-top: 1px solid #eee; margin: 30px 0 20px 0; }
        .button-wrapper { text-align: center; padding: 10px 0; }
        #multiSubmitBtn { display: none; width: 90%; padding: 15px; background: #22b8cf; color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(34, 184, 207, 0.3); transition: 0.2s; }
        #multiSubmitBtn:hover:not(:disabled) { background: #1199ab; transform: translateY(-1px); }
        #multiSubmitBtn:disabled { background: #ccc; box-shadow: none; }
        #shareSection { margin-top: 20px; display: none; background: #e7f5ff; padding: 15px; border-radius: 8px; border: 1px solid #d0e7ff; }
        #shareLink { display: block; word-break: break-all; font-size: 11px; color: #666; margin-bottom: 10px; background: white; padding: 8px; border-radius: 4px; border: 1px solid #eee; }
        .share-buttons { display: flex; gap: 8px; }
        .btn-copy { flex: 2; background: #51cf66; }
        .btn-open { flex: 1; background: #4dabf7; }
        .voted-msg { color: #fa5252; font-size: 0.9em; text-align: center; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>
<div class="card">
    <h2 id="title">æŠ•ç¥¨ãƒšãƒ¼ã‚¸ã‚’ä½œã‚ã† ğŸ—³ï¸</h2>
    <div id="createMode">
        <p style="font-size: 14px; color: #666;">é¸æŠè‚¢ã‚’æ”¹è¡ŒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</p>
        <textarea id="listInput" placeholder="ã‚Šã‚“ã”&#13;&#10;ãƒãƒŠãƒŠ&#13;&#10;ã¶ã©ã†"></textarea>
        <div class="config-group">
            <div class="config-item"><label>1äººã‚ãŸã‚Šã®æœ€å¤§å›ç­”æ•°ï¼š</label>
                <select id="voteCount"><option value="1">1ã¤ï¼ˆå˜ä¸€å›ç­”ï¼‰</option><option value="2">2ã¤ã¾ã§</option><option value="3">3ã¤ã¾ã§</option><option value="4">4ã¤ã¾ã§</option><option value="5">5ã¤ã¾ã§</option></select>
            </div>
        </div>
        <button class="btn-main" onclick="generatePage()">ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹</button>
        <div id="shareSection">
            <span style="font-size: 12px; font-weight: bold; color: #1c7ed6;">å…±æœ‰ç”¨URL:</span>
            <div id="shareLink"></div>
            <div class="share-buttons">
                <button class="btn-main btn-copy" onclick="copyUrl()">URLã‚’ã‚³ãƒ”ãƒ¼</button>
                <button class="btn-main btn-open" onclick="openUrl()">é–‹ã</button>
            </div>
        </div>
    </div>
    <div id="voteMode" style="display: none;">
        <p id="instruction" style="font-weight:bold; color:#ff6b6b; text-align:center; margin-bottom: 20px;"></p>
        <div id="buttonContainer"></div>
        <hr class="vote-divider">
        <div class="button-wrapper"><button id="multiSubmitBtn" onclick="submitMultiVote()">æŠ•ç¥¨ã‚’é€ä¿¡ã™ã‚‹</button></div>
        <div id="votedAlert" class="voted-msg" style="display:none;">â€»ã“ã®æŠ•ç¥¨ãƒšãƒ¼ã‚¸ã§ã¯å›ç­”æ¸ˆã¿ã§ã™</div>
        <div style="text-align:center; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <a id="toResultPage" href="#" style="color:#4dabf7; text-decoration:none; font-size:14px; font-weight:bold;">ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµæœã‚’è¦‹ã‚‹</a>
        </div>
    </div>
</div>

<script>
    const FORM_ID = "1E7-uEASFhZaTaCwbM1MU_A1e1LRCJIDC7DUktioSFFE";
    const ENTRY_ID_LIST = "entry.1232564170"; 
    const ENTRY_ID_ITEM = "entry.643804669"; 
    const ENTRY_ID_UID = "entry.480076246"; // æ­£ã—ã„IDã«ä¿®æ­£ã—ã¾ã—ãŸ

    async function generateHash(text) {
        const msgUint8 = new TextEncoder().encode(text);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
    }

    function generatePage() {
        const text = document.getElementById('listInput').value.trim();
        if (!text) return alert("é¸æŠè‚¢ã‚’å…¥åŠ›ã—ã¦ã­ï¼");
        const config = { items: text.split('\n').filter(i => i.trim()), max: document.getElementById('voteCount').value };
        const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(config))));
        const url = window.location.origin + window.location.pathname + "#v=" + encoded;
        document.getElementById('shareLink').innerText = url;
        document.getElementById('shareSection').style.display = "block";
    }

    async function init() {
        const hashStr = window.location.hash.substring(1);
        if (hashStr.startsWith("v=")) {
            const rawData = hashStr.replace("v=", "");
            try {
                const decoded = JSON.parse(decodeURIComponent(escape(atob(rawData))));
                setupVoteMode(decoded, rawData);
            } catch (e) { alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
        }
    }

    let currentConfig = {};
    let pageRawData = "";

    function setupVoteMode(config, rawHash) {
        pageRawData = rawHash;
        currentConfig = config;
        document.getElementById('createMode').style.display = "none";
        document.getElementById('voteMode').style.display = "block";
        document.getElementById('title').innerText = "æŠ•ç¥¨å—ä»˜ä¸­ ğŸ—³ï¸";

        const history = JSON.parse(localStorage.getItem('voted_history_v2') || "[]");
        const myVoteRecord = history.find(h => h.id === pageRawData);
        const hasVoted = !!myVoteRecord;

        const isMulti = currentConfig.max > 1;
        if (isMulti) document.getElementById('multiSubmitBtn').style.display = "inline-block";
        document.getElementById('instruction').innerText = isMulti ? `æœ€å¤§ ${currentConfig.max} ã¤ã¾ã§é¸ã¹ã¾ã™` : "ã©ã‚Œã‹1ã¤é¸ã‚“ã§ãã ã•ã„";
        document.getElementById('toResultPage').href = "result.html#items=" + pageRawData;

        const container = document.getElementById('buttonContainer');
        currentConfig.items.forEach((item, index) => {
            const id = "item-" + index;
            const wrap = document.createElement('div');
            const isMyVote = myVoteRecord && myVoteRecord.selected.includes(item);
            wrap.innerHTML = `<input type="checkbox" id="${id}" class="vote-check" value="${item}" ${hasVoted ? 'disabled' : ''}>
                <label for="${id}" class="${isMyVote ? 'item-label my-vote-label' : 'item-label'}">${hasVoted ? item + ' (æ¸ˆ)' : item}</label>`;
            container.appendChild(wrap);
            if (!isMulti && !hasVoted) {
                wrap.querySelector('label').onclick = (e) => { e.preventDefault(); submitMultiVote([item]); };
            }
        });
        if (hasVoted) {
            document.getElementById('votedAlert').style.display = "block";
            document.getElementById('multiSubmitBtn').disabled = true;
            document.getElementById('multiSubmitBtn').innerText = "æŠ•ç¥¨æ¸ˆã¿";
        }
    }

    async function submitMultiVote(quickItem = null) {
        const selected = quickItem || Array.from(document.querySelectorAll('.vote-check:checked')).map(el => el.value);
        if (selected.length === 0) return alert("1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„");

        const sessionUid = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        const listHash = await generateHash(pageRawData);
        const url = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`;

        try {
            for (const item of selected) {
                const params = new URLSearchParams();
                params.append(ENTRY_ID_LIST, listHash);
                params.append(ENTRY_ID_ITEM, item);
                params.append(ENTRY_ID_UID, sessionUid);
                await fetch(url, { method: "POST", mode: "no-cors", body: params });
            }
            const history = JSON.parse(localStorage.getItem('voted_history_v2') || "[]");
            history.push({ id: pageRawData, selected: selected });
            localStorage.setItem('voted_history_v2', JSON.stringify(history));
            alert("æŠ•ç¥¨ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
            location.reload();
        } catch (e) { alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + e.message); }
    }

    function copyUrl() { navigator.clipboard.writeText(document.getElementById('shareLink').innerText).then(() => alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼")); }
    function openUrl() { window.open(document.getElementById('shareLink').innerText, '_blank'); }
    init();
</script>
</body>
</html>
